{% extends 'base.html' %}
{% load static %}

{% block title %}HR Dashboard {% endblock %}

{% block content %}


<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-primary">HR Dashboard</h1>
                    <p class="text-muted">Manage and review job applications</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="exportBtn">
                        <i class="fas fa-download me-2"></i>Export
                    </button> 
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statsModal">
                        <i class="fas fa-chart-bar me-2"></i>View Analytics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_applications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-briefcase fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <a href="{% url 'nurse_app'%}" class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Nurse Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ nurse_applications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-nurse fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>

        <a href="{% url 'other_app' %}" class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Other Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ other_applications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                This Month
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ monthly_applications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card shadow mb-4">
        <div class="card-body">

            <div class="row g-3">

                <div class="col-md-3">
                            <form method="get">
                        <label class="form-label">Sector</label>
                        <select class="form-select" name="sectors" id="sectorFilter" onchange="this.form.submit()">
                            <option value="" {% if not sectors_filter %} selected {%endif%}>All Sectors</option>
                            <option value="Nurse" {% if sectors_filter == "Nurse" %} selected {%endif%}> Nurse</option>
                            <option value="Others" {% if sectors_filter == "Others" %} selected {%endif%}> Others</option>
                        </select>
                    </form>
                    </div>

                    <div class="col-md-3">
                <form action="" method="get">
                        <label class="form-label">Date Range</label>
                        <input type="date" class="form-control" id="dateFilter" onchange="this.form.submit()"
                            name="date">
                        </form>
                    </div>

                <div class="col-md-4">
                    <form action="" method="get">
                    <label class="form-label">Search Applications</label>
                    <input type="text" class="form-control"  name="q" id="searchInput" placeholder="Search by name, email..." required>
                    
                </div>
                
                <div class="col-md-2 d-flex align-items-end"> 
                    <button class="btn btn-primary w-100" id="filterBtn" type="submit">
                        <i class="fas fa-filter me-2"></i>Filter  
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Job Applications</h6>
                    <span class="badge bg-primary">{{ applications.count }} applications</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="applicationsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Applicant</th>
                                    <th>Sector</th>
                                    <th>Contact</th>
                                    <th>Application Date</th>
                                    <th>About Us</th>
                                    <th>Documents</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for application in applications %}
                                <tr class="application-row" data-sector="{{ application.sector }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-primary text-white me-3">
                                                {{ application.first_name|first|upper }}{{application.last_name|first|upper }}
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ application.first_name }} {{ application.last_name }}</h6>
                                                <small class="text-muted">Applied: {{ application.date|date:"M d, Y"}}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if application.sector == 'Nurse' %}bg-success{% else %}bg-info{% endif %}">
                                            {{ application.sector }}
                                        </span>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="text-primary">{{ application.email }}</div>
                                            <small class="text-muted">
                                                <a href="{{ application.url }}" target="_blank"
                                                    class="text-decoration-none">
                                                    <i class="fas fa-link me-1"></i>Portfolio
                                                </a>
                                            </small>
                                        </div>
                                    </td> 
                                    <td>
                                        <div class="fw-bold">{{ application.date|date:"M d, Y" }}</div>
                                        <small class="text-muted">{{ application.date|time:"g:i A" }}</small>
                                    </td>
                                    <td>
                                        <div class="about-text" data-bs-toggle="tooltip"
                                            title="{{ application.about_us }}">
                                            {{ application.about_us|truncatewords:8 }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            {% if application.resume %}
                                            <a href="{{ application.resume.url }}"
                                                class="btn btn-outline-primary btn-download" download>
                                                <i class="fas fa-file-pdf me-1"></i>Resume
                                            </a>
                                            {% endif %}
                                            {% if application.cover_letter %}
                                            <a href="{{ application.cover_letter.url }}"
                                                class="btn btn-outline-success btn-download mt-1" download>
                                                <i class="fas fa-file-word me-1"></i>Cover Letter
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary view-application"
                                                data-bs-toggle="modal"
                                                data-bs-target="#detailModal{{ application.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <!-- <button class="btn btn-sm btn-outline-success quick-action" 
                                                    data-application-id="{{ application.id }}"
                                                    data-action="shortlist">
                                                <i class="fas fa-star"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger quick-action" 
                                                    data-application-id="{{ application.id }}"
                                                    data-action="reject">
                                                <i class="fas fa-times"></i>
                                            </button> -->
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="empty-state">
                                            <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                                            <h5>No Applications Found</h5>
                                            <p class="text-muted">There are no job applications yet.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if applications.has_other_pages %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if applications.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ applications.previous_page_number }}">Previous</a>
                            </li>
                            {% endif %}

                            {% for num in applications.paginator.page_range %}
                            <li class="page-item {% if applications.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endfor %}

                            {% if applications.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ applications.next_page_number }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Detail Modals -->
{% for application in applications %}
<div class="modal fade" id="detailModal{{ application.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Application Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Personal Information</h6>
                        <p><strong>Name:</strong> {{ application.first_name }} {{ application.last_name }}</p>
                        <p><strong>Sector:</strong> {{ application.sector }}</p>
                        <p><strong>Email:</strong> {{ application.email }}</p>
                        <p><strong>Portfolio:</strong>
                            <a href="{{ application.url }}" target="_blank" class="text-decoration-none">
                                {{ application.url|truncatechars:30 }}
                            </a>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Application Details</h6>
                        <p><strong>Applied On:</strong> {{ application.date|date:"F d, Y" }}</p>
                        <p><strong>Time:</strong> {{ application.date|time:"g:i A" }}</p>

                        <div class="mt-3">
                            <h6>Documents</h6>
                            <div class="d-flex gap-2">
                                {% if application.resume %}
                                <a href="{{ application.resume.url }}" class="btn btn-outline-primary btn-sm" download>
                                    <i class="fas fa-download me-1"></i>Resume
                                </a>
                                {% endif %}
                                {% if application.cover_letter %}
                                <a href="{{ application.cover_letter.url }}" class="btn btn-outline-success btn-sm"
                                    download>
                                    <i class="fas fa-download me-1"></i>Cover Letter
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6>About Us Section</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-0">{{ application.about_us }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <!-- <div class="btn-group">
                    <button class="btn btn-success quick-action" 
                            data-application-id="{{ application.id }}"
                            data-action="shortlist">
                        <i class="fas fa-star me-1"></i>Shortlist
                    </button>
                    <button class="btn btn-danger quick-action" 
                            data-application-id="{{ application.id }}"
                            data-action="reject">
                        <i class="fas fa-times me-1"></i>Reject
                    </button>
                </div> -->
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Stats Modal -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Application Analytics</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6>Sector Distribution</h6>
                                <canvas id="sectorChart" width="200" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6>Monthly Applications</h6>
                                <canvas id="monthlyChart" width="200" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .about-text {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }

    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }

    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }

    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }

    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }

    .card {
        border: none;
        border-radius: 10px;
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .btn-download {
        transition: all 0.3s ease;
    }

    .btn-download:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .application-row {
        transition: all 0.3s ease;
    }

    .application-row:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.01);
    }

    .empty-state {
        padding: 3rem 0;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    @media (max-width: 768px) {
        .btn-group-vertical {
            flex-direction: row !important;
            gap: 5px;
        }

        .about-text {
            max-width: 100px;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => {
            new bootstrap.Tooltip(tooltip);
        });

        // document.getElementById("filterBtn").addEventListener('click',(e)=>{
        //     e.preventDefault()
        // })

        document.getElementById('exportBtn').addEventListener('click', function () {
            Swal.fire({
                title: 'Export Data',
                text: 'This feature will be available soon!',
                icon: 'info',
                confirmButtonText: 'OK'
            });
        });

        // Initialize charts (simplified version)
        const sectorCtx = document.getElementById('sectorChart').getContext('2d');
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');

        // Sample chart data - you would replace this with actual data from your context
        new Chart(sectorCtx, {
            type: 'doughnut',
            data: {
                labels: ['Nurse', 'Others'],
                datasets: [{
                    data: [{{ nurse_applications }}, {{ other_applications }}],
            backgroundColor: ['#28a745', '#17a2b8']
        }]
            }
        });

    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Applications',
                data: [12, 19, 15, 25, 22, 30],
                borderColor: '#007bff',
                tension: 0.1
            }]
        }
    }); 
    });

</script>



{% endblock %}